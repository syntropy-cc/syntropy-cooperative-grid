# Syntropy CLI - Variáveis de Ambiente para Setup Avançado
# Arquivo para automatização de setup em diferentes ambientes
#
# Author: Syntropy Team  
# Version: 1.1.0
# Created: 2025-01-27
#
# Purpose: Configurar variáveis de ambiente para setups automatizados
#          em ambientes enterprise e de produção
#
# Usage Examples:
#   # Desenvolvimento:
#   source environment-variables.env
#   ./../basic-setup/setup-basic.sh
#   
#   # Produção:
#   export ENVIRONMENT=production && source environment-variables.env  
#   ./../basic-setup/setup-basic.sh
#
# Override Strategy:
#   1. System environment (highest priority)  
#   2. This file 
#   3. Defaults (lowest priority)

# ============================================================================
# CONFIGURAÇÕES BÁSICAS E AMBIENTE
# ============================================================================

# Ambiente de execução (development, staging, production)
SYNTHROPY_ENV=${SYNTHROPY_ENV:-development}

# Diretório base para arquivos do Syntropy
SYNTHROPY_HOME=${SYNTHROPY_HOME:-$HOME/.syntropy}

# Nível de log (debug, info, warn, error, audit)
SYNTHROPY_LOG_LEVEL=${SYNTHROPY_LOG_LEVEL:-info}

# Endpoint base da API Syntropy
SYNTHROPY_API_ENDPOINT=${SYNTHROPY_API_ENDPOINT:-https://api.syntropy.io}

# Company/Tenant information
SYNTHROPY_COMPANY=${SYNTHROPY_COMPANY:-}
SYNTHROPY_TENANT=${SYNTHROPY_TENANT:-default}

# Flags de configuração do sistema
SYNTHROPY_DEBUG=${SYNTHROPY_DEBUG:-false}
SYNTHROPY_CI=${SYNTHROPY_CI:-false}
SYNTHROPY_SKIP_SERVICE=${SYNTHROPY_SKIP_SERVICE:-false}
SYNTHROPY_FORCE_SETUP=${SYNTHROPY_FORCE_SETUP:-false}

# ============================================================================
# CONFIGURAÇÕES DE REDE E CONECTIVIDADE  
# ============================================================================

# Configuração de proxy (se necessário)
SYNTHROPY_PROXY_ENABLED=${SYNTHROPY_PROXY_ENABLED:-false}
HTTP_PROXY=${HTTP_PROXY:-}
HTTPS_PROXY=${HTTPS_PROXY:-} 
NO_PROXY=${NO_PROXY:-localhost,127.0.0.1,*.internal}

# Timeout de conexão (em segundos)
SYNTHROPY_TIMEOUT=${SYNTHROPY_TIMEOUT:-30}

# Configurações de retry
SYNTHROPY_MAX_RETRIES=${SYNTHROPY_MAX_RETRIES:-3}
SYNTHROPY_RETRY_INTERVAL=${SYNTHROPY_RETRY_INTERVAL:-5}

# Configuração de load balance
SYNTHROPY_PRIMARY_HOST=${SYNTHROPY_PRIMARY_HOST:-}
SYNTHROPY_PRIMARY_PORT=${SYNTHROPY_PRIMARY_PORT:-443}
SYNTHROPY_SECONDARY_HOST=${SYNTHROPY_SECONDARY_HOST:-}
SYNTHROPY_SECONDARY_PORT=${SYNTHROPY_SECONDARY_PORT:-443}

# ============================================================================
# CONFIGURAÇÕES DE CLUSTER E HIGH AVAILABILITY
# ============================================================================

# Configuração de cluster
SYNTHROPY_CLUSTER_ENABLED=${SYNTHROPY_CLUSTER_ENABLED:-true}
SYNTHROPY_CLUSTER_NAME=${SYNTHROPY_CLUSTER_NAME:-syntropy-cluster}

# Nós do cluster (múltiplos suportados via array)
SYNTHROPY_NODE1_HOST=${SYNTHROPY_NODE1_HOST:-}
SYNTHROPY_NODE1_PORT=${SYNTHROPY_NODE1_PORT:-443}
SYNTHROPY_NODE2_HOST=${SYNTHROPY_NODE2_HOST:-}
SYNTHROPY_NODE2_PORT=${SYNTHROPY_NODE2_PORT:-443}
SYNTHROPY_NODE3_HOST=${SYNTHROPY_NODE3_HOST:-}
SYNTHROPY_NODE3_PORT=${SYNTHROPY_NODE3_PORT:-443}

# Service Discovery configs
CONSUL_HOST=${CONSUL_HOST:-consul.internal}
CONSUL_PORT=${CONSUL_PORT:-8500}

# ============================================================================
# CONFIGURAÇÕES DE PERFORMANCE E RECURSOS
# ============================================================================

# Limites de recursos do sistema
SYNTHROPY_MEMORY_LIMIT=${SYNTHROPY_MEMORY_LIMIT:-4}
SYNTHROPY_CPU_CORES=${SYNTHROPY_CPU_CORES:-2}
SYNTHROPY_MAX_CONNECTIONS=${SYNTHROPY_MAX_CONNECTIONS:-1000}

# Configurações de disco
SYNTHROPY_DISK_MIN_FREE_GB=${SYNTHROPY_DISK_MIN_FREE_GB:-10}

# ============================================================================
# CONFIGURAÇÕES DE SEGURANÇA E AUTENTICAÇÃO
# ============================================================================

# Configuração de autenticação
SYNTHROPY_AUTH_LDAP_ENABLED=${SYNTHROPY_AUTH_LDAP_ENABLED:-false}
SYNTHROPY_AUTH_OAUTH_ENABLED=${SYNTHROPY_AUTH_OAUTH_ENABLED:-false}

# LDAP Configuration  
LDAP_SERVER=${LDAP_SERVER:-}
LDAP_USER=${LDAP_USER:-}
LDAP_PASSWORD=${LDAP_PASSWORD:-}
LDAP_BASE_DN=${LDAP_BASE_DN:-}

# OAuth Providers
OAUTH_PROVIDER=${OAUTH_PROVIDER:-auth0}
OAUTH_CLIENT_ID=${OAUTH_CLIENT_ID:-}
OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET:-}
OAUTH_ISSUER=${OAUTH_ISSUER:-}

# SSL/TLS Certificates 
SSL_CERT_PATH=${SSL_CERT_PATH:-}
SSL_KEY_PATH=${SSL_KEY_PATH:-}
SSL_CA_PATH=${SSL_CA_PATH:-}

# ============================================================================
# CONFIGURAÇÕES DE MONITORAMENTO E ALERTAS
# ============================================================================

# Status dashboards
PROMETHEUS_ENABLED=${PROMETHEUS_ENABLED:-true}
PROMETHEUS_ENDPOINT=${PROMETHEUS_ENDPOINT:-}
PROMETHEUS_PORT=${PROMETHEUS_PORT:-9090}

GRAFANA_ENABLED=${GRAFANA_ENABLED:-false}
GRAFANA_ENDPOINT=${GRAFANA_ENDPOINT:-}
GRAFANA_DASHBOARD_ID=${GRAFANA_DASHBOARD_ID:-syntropy-overview}

# Alerting integrations
SLACK_WEBHOOK=${SLACK_WEBHOOK:-}
PAGERDUTY_INTEGRATION_KEY=${PAGERDUTY_INTEGRATION_KEY:-}
EMAIL_FROM=${EMAIL_FROM:-}
EMAIL_TO=${EMAIL_TO:-}

# Logging
LOG_REMOTE_ENDPOINT=${LOG_REMOTE_ENDPOINT:-}
LOG_LEVEL=${LOG_LEVEL:-info}

# ============================================================================
# CONFIGURAÇÕES DE BACKUP E DISASTER RECOVERY
# ============================================================================

# Backup configuration
BACKUP_S3_ENABLED=${BACKUP_S3_ENABLED:-false}
BACKUP_NFS_ENABLED=${BACKUP_NFS_ENABLED:-false}

# AWS S3 for enterprise backup
AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
AWS_S3_BUCKET=${AWS_S3_BUCKET:-}
AWS_REGION=${AWS_REGION:-us-east-1}

# NFS backup storage
NFS_BACKUP_SHARE=${NFS_BACKUP_SHARE:-}
NFS_USER=${NFS_USER:-}
NFS_PASSWORD=${NFS_PASSWORD:-}

# Local backup directory
SYNTHROPY_BACKUP_DIR=${SYNTHROPY_BACKUP_DIR:-backup}

# ============================================================================
# CONFIGURAÇÕES ESPECÍFICAS PLATAFORMA WINDOWS
# ============================================================================

# Windows Service configuration (quando aplicável)
if [[ "$(uname)" == "CYGWIN"* ]] || command -v systeminfo >/dev/null 2>&1; then
    export SYNTHROPY_SERVICE_USER=${SYNTHROPY_SERVICE_USER:-SYSTEM}
    export SYNTHROPY_REGISTRY_KEY=HKEY_LOCAL_MACHINE\\Software\\Syntropy\\Manager
fi

# ============================================================================
# CONFIGURAÇÕES ESPECÍFICAS PLATAFORMA LINUX  
# ============================================================================

if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    export SYNTHROPY_SYSTEMD_ENABLED=${SYNTHROPY_SYSTEMD_ENABLED:-true}
    export SYNTHROPY_UID=${SYNTHROPY_UID:-1000}
    export SYNTHROPY_GID=${SYNTHROPY_GID:-1000}
fi

# ============================================================================
# CONFIGURAÇÕES ESPECÍFICAS PLATAFORMA MACOS
# ============================================================================

if [[ "$OSTYPE" == "darwin"* ]]; then
    export SYNTHROPY_LAUNCHD_ENABLED=${SYNTHROPY_LAUNCHD_ENABLED:-true}
    export SYNTHROPY_USER_DAEMON=${SYNTHROPY_USER_DAEMON:-true}
fi

# ============================================================================
# CONFIGURAÇÕES DE DESENVOLVIMENTO E TESTES
# ============================================================================

# Flags para ambientes de desenvolvimento
if [[ "$SYNTHROPY_ENV" == "development" ]]; then
    export SYNTHROPY_DEBUG=true
    export SYNTHROPY_TEST_MODE=${SYNTHROPY_TEST_MODE:-true}
    export SYNTHROPY_LOG_LEVEL=debug
fi

# Flags para ambientes de CI/CD
if [[ "$SYNTHROPY_CI" == "true" ]]; then
    export SYNTHROPY_SKIP_SERVICE=true
    export SYNTHROPY_LOG_LEVEL=warn
    export SYNTHROPY_FORCE_SETUP=true
fi

# Flags para teste mode (opcional)
if [[ "$SYNTHROPY_TEST_MODE" == "true" ]]; then
    export SYNTHROPY_MOCK_APIS=true
    export SYNTHROPY_BYPASS_AUTH=true
fi

# ============================================================================
# CONFIGURAÇÕES DE INFRAESTRUTURA EXTERNA  
# ============================================================================

# Message brokers (Kafka, RabbitMQ, etc.)
KAFKA_BROKERS=${KAFKA_BROKERS:-kafka1:9092,kafka2:9092}
KAFKA_TOPIC=${KAFKA_TOPIC:-syntropy.events}
RABBITMQ_URL=${RABBITMQ_URL:-}

# Database configurations (se aplicável)
DATABASE_URL=${DATABASE_URL:-}
DB_USER=${DB_USER:-}
DB_PASSWORD=${DB_PASSWORD:-}

# External monitoring/observability 
ELASTICSEARCH_ENDPOINT=${ELASTICSEARCH_ENDPOINT:-}
JAEGER_ENDPOINT=${JAEGER_ENDPOINT:-}
FLUENTD_URL=${FLUENTD_URL:-}

# ============================================================================
# CONFIGURAÇÕES DE SEGURANÇA AVANÇADA
# ============================================================================

# Kubernetes secrets (se executando no K8s)
if [[ -n "$KUBERNETES_SERVICE_HOST" ]]; then
    export SYNTHROPY_TOKEN_FILE=/var/secrets/syntropy-token
    export SYNTHROPY_CERT_FILE=/var/secrets/syntropy-cert
fi

# HashiCorp Vault integration
VAULT_ADDR=${VAULT_ADDR:-}
VAULT_TOKEN=${VAULT_TOKEN:-}
VAULT_ROLE_ID=${VAULT_ROLE_ID:-}
VAULT_SECRET_ID=${VAULT_SECRET_ID:-}

# Certificate Management
VECTOR_DOCKER_CONTAINER_NAME=${VECTOR_DOCKER_CONTAINER_NAME:-}

# ============================================================================
# VALIDATION FUNCTIONS (Shell only)
# ============================================================================

# Função para validar variáveis críticas (melhoria opcional)
validate_syntropy_env() {
    if [[ -z "$SYNTHROPY_HOME" ]]; then  
        echo "ERRO: SYNTHROPY_HOME não definido"
        return 1
    fi
    
    if [[ -z "$SYNTHROPY_API_ENDPOINT" ]]; then
        echo "ERRO: SYNTHROPY_API_ENDPOINT não definido" 
        return 1
    fi
    
    echo "✓ Variáveis Syntropy validadas"
    return 0
}

# Função para configurar ambiente de acordo com o contexto
configure_environment() {
    local env=${SYNTHROPY_ENV:-development}
    
    case "$env" in
        "development")
            SYNTHROPY_DEBUG=true
            SYNTHROPY_LOG_LEVEL=debug
            ;;
        "staging")
            SYNTHROPY_LOG_LEVEL=info
            SYNTHROPY_FORCE_SETUP=false
            ;;
        "production")
            SYNTHROPY_LOG_LEVEL=warn
            SYNTHROPY_FORCE_SETUP=false
            BACKUP_S3_ENABLED=true
            PROMETHEUS_ENABLED=true
            ;;
    esac
    
    echo "✓ Ambiente configurado para: $env"
}
