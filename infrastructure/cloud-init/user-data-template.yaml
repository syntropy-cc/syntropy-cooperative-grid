#cloud-config
# Ubuntu Server 24.04 LTS - Syntropy Cooperative Grid Node
# Este arquivo configura automaticamente um nó da rede Syntropy
# Gerado automaticamente pelo PC de trabalho (Quartel General)

# Configurações básicas do sistema
locale: pt_BR.UTF-8
timezone: America/Sao_Paulo
hostname: ${NODE_NAME}

# Usuário padrão (será substituído pela configuração Syntropy)
users:
  - name: syntropy
    groups: [adm, sudo, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: true
    ssh_authorized_keys:
      - ${SSH_PUBLIC_KEY}

# Configuração de rede
network:
  version: 2
  ethernets:
    ${INTERFACE}:
      dhcp4: true
      dhcp6: false

# Configuração SSH
ssh_pwauth: false
disable_root: true
ssh_authorized_keys:
  - ${SSH_PUBLIC_KEY}

# Pacotes a serem instalados
packages:
  - curl
  - wget
  - git
  - htop
  - vim
  - net-tools
  - dnsutils
  - fail2ban
  - ufw
  - docker.io
  - docker-compose-plugin
  - containerd
  - kubectl
  - wireguard
  - jq
  - openssl
  - ca-certificates
  - gnupg
  - lsb-release
  - apt-transport-https
  - prometheus-node-exporter
  - ntp
  - rsync
  - unzip
  - tree
  - tmux

# Configuração do Docker
runcmd:
  # Configurar Docker
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker syntropy
  
  # Configurar firewall
  - ufw --force enable
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow 6443/tcp
  - ufw allow 2379:2380/tcp
  - ufw allow 10250/tcp
  - ufw allow 10251/tcp
  - ufw allow 10252/tcp
  - ufw allow 30000:32767/tcp
  - ufw allow 51820/udp
  - ufw allow 8080/tcp
  - ufw allow 9090/tcp
  - ufw allow 9100/tcp
  
  # Configurar fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Criar diretórios Syntropy
  - mkdir -p /opt/syntropy/{bin,config,logs,certs,data,scripts,backups,audit}
  - chown -R syntropy:syntropy /opt/syntropy
  
  # Download e instalação do Syntropy Agent
  - curl -L https://github.com/syntropy-cooperative-grid/agent/releases/latest/download/syntropy-agent-linux-amd64 -o /opt/syntropy/bin/syntropy-agent
  - chmod +x /opt/syntropy/bin/syntropy-agent
  
  # Configurar certificados
  - cp ${NODE_CERT_PATH} /opt/syntropy/certs/node.crt
  - cp ${NODE_KEY_PATH} /opt/syntropy/certs/node.key
  - cp ${CA_CERT_PATH} /opt/syntropy/certs/ca.crt
  - chmod 600 /opt/syntropy/certs/*
  - chown syntropy:syntropy /opt/syntropy/certs/*
  
  # Configurar Syntropy Agent
  - cat > /opt/syntropy/config/agent.yaml << EOF
node:
  name: "${NODE_NAME}"
  type: "${NODE_TYPE}"
  description: "${NODE_DESCRIPTION}"
  coordinates: "${COORDINATES}"
  owner_key: "${OWNER_KEY}"

network:
  discovery_endpoints:
    - "https://${DISCOVERY_SERVER}:8443"
  mesh_port: 51820
  api_port: 8080

security:
  tls:
    enabled: true
    cert_file: "/opt/syntropy/certs/node.crt"
    key_file: "/opt/syntropy/certs/node.key"
    ca_file: "/opt/syntropy/certs/ca.crt"
  
  firewall:
    enabled: true
    default_policy: "deny"
    allow_ssh: true
    allow_management: true

logging:
  level: "info"
  file: "/opt/syntropy/logs/agent.log"
  max_size: "100MB"
  max_files: 5

metrics:
  enabled: true
  port: 9090
  path: "/metrics"
EOF
  
  # Configurar systemd service
  - cat > /etc/systemd/system/syntropy-agent.service << EOF
[Unit]
Description=Syntropy Cooperative Grid Agent
After=network.target docker.service
Wants=docker.service

[Service]
Type=simple
User=syntropy
Group=syntropy
WorkingDirectory=/opt/syntropy
ExecStart=/opt/syntropy/bin/syntropy-agent --config=/opt/syntropy/config/agent.yaml
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
  
  # Iniciar Syntropy Agent
  - systemctl daemon-reload
  - systemctl enable syntropy-agent
  - systemctl start syntropy-agent
  
  # Configurar logrotate
  - cat > /etc/logrotate.d/syntropy << EOF
/opt/syntropy/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 syntropy syntropy
    postrotate
        systemctl reload syntropy-agent
    endscript
}
EOF

# Configurações finais
final_message: |
  ✅ Nó Syntropy configurado com sucesso!
  
  📊 Informações do Nó:
  - Nome: ${NODE_NAME}
  - Tipo: ${NODE_TYPE}
  - Descrição: ${NODE_DESCRIPTION}
  - Coordenadas: ${COORDINATES}
  
  🔐 Segurança:
  - SSH configurado com chave pública
  - Firewall ativo
  - Fail2ban configurado
  - Certificados TLS instalados
  
  🌐 Rede:
  - Descoberta: ${DISCOVERY_SERVER}
  - Mesh: porta 51820
  - API: porta 8080
  
  📝 Logs:
  - Agent: /opt/syntropy/logs/agent.log
  - System: journalctl -u syntropy-agent
  
  🚀 Status: systemctl status syntropy-agent