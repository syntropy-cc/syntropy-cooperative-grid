# Script de Configura√ß√£o Autom√°tica - USB Syntropy para Windows
# Execute este script como Administrador para configurar o ambiente automaticamente

param(
    [string]$WSLDistro = "Ubuntu",
    [switch]$Force,
    [switch]$SkipWSL,
    [switch]$SkipPolicy
)

$ErrorActionPreference = "Stop"

Write-Host "üöÄ Configura√ß√£o Autom√°tica - USB Syntropy para Windows" -ForegroundColor Green
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Cyan
Write-Host ""

# Fun√ß√£o para verificar se est√° executando como Administrador
function Test-Administrator {
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

# Verificar privil√©gios de administrador
if (-not (Test-Administrator)) {
    Write-Host "‚ùå ERRO: Este script deve ser executado como Administrador!" -ForegroundColor Red
    Write-Host "üí° Solu√ß√£o: Clique com bot√£o direito no PowerShell e selecione 'Executar como administrador'" -ForegroundColor Yellow
    exit 1
}

Write-Host "‚úÖ Executando como Administrador" -ForegroundColor Green
Write-Host ""

# Fun√ß√£o para verificar se comando existe
function Test-Command($command) {
    try {
        Get-Command $command -ErrorAction Stop | Out-Null
        return $true
    } catch {
        return $false
    }
}

# Fun√ß√£o para instalar WSL
function Install-WSL {
    Write-Host "üêß Instalando WSL..." -ForegroundColor Yellow
    
    try {
        # Verificar se WSL j√° est√° instalado
        if (Test-Command "wsl") {
            $wslVersion = wsl --version 2>$null
            if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ WSL j√° est√° instalado" -ForegroundColor Green
                return $true
            }
        }
        
        # Instalar WSL
        Write-Host "üì¶ Instalando WSL..." -ForegroundColor Yellow
        wsl --install --no-launch
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ WSL instalado com sucesso" -ForegroundColor Green
            Write-Host "‚ö†Ô∏è  Reinicializa√ß√£o pode ser necess√°ria" -ForegroundColor Yellow
            return $true
        } else {
            Write-Host "‚ùå Falha na instala√ß√£o do WSL" -ForegroundColor Red
            return $false
        }
    } catch {
        Write-Host "‚ùå Erro na instala√ß√£o do WSL: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

# Fun√ß√£o para configurar distribui√ß√£o WSL
function Setup-WSLDistribution($distro) {
    Write-Host "üêß Configurando distribui√ß√£o WSL: $distro" -ForegroundColor Yellow
    
    try {
        # Verificar se distribui√ß√£o j√° est√° instalada
        $installedDistros = wsl --list --quiet 2>$null
        if ($installedDistros -contains $distro) {
            Write-Host "‚úÖ Distribui√ß√£o $distro j√° est√° instalada" -ForegroundColor Green
            return $true
        }
        
        # Instalar distribui√ß√£o
        Write-Host "üì¶ Instalando $distro..." -ForegroundColor Yellow
        wsl --install -d $distro
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host "‚úÖ $distro instalado com sucesso" -ForegroundColor Green
            return $true
        } else {
            Write-Host "‚ùå Falha na instala√ß√£o de $distro" -ForegroundColor Red
            return $false
        }
    } catch {
        Write-Host "‚ùå Erro na configura√ß√£o de $distro: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

# Fun√ß√£o para configurar pol√≠tica de execu√ß√£o
function Set-ExecutionPolicyForSyntropy {
    Write-Host "‚öôÔ∏è  Configurando pol√≠tica de execu√ß√£o do PowerShell..." -ForegroundColor Yellow
    
    try {
        $currentPolicy = Get-ExecutionPolicy -Scope CurrentUser
        Write-Host "üìã Pol√≠tica atual (CurrentUser): $currentPolicy" -ForegroundColor Cyan
        
        if ($currentPolicy -eq "Restricted") {
            Write-Host "üîß Alterando pol√≠tica para RemoteSigned..." -ForegroundColor Yellow
            Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
            Write-Host "‚úÖ Pol√≠tica configurada com sucesso" -ForegroundColor Green
        } else {
            Write-Host "‚úÖ Pol√≠tica j√° est√° configurada adequadamente" -ForegroundColor Green
        }
        
        return $true
    } catch {
        Write-Host "‚ùå Erro na configura√ß√£o da pol√≠tica: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

# Fun√ß√£o para instalar ferramentas necess√°rias
function Install-RequiredTools {
    Write-Host "üõ†Ô∏è  Verificando ferramentas necess√°rias..." -ForegroundColor Yellow
    
    $tools = @(
        @{Name="PowerShell"; Command="powershell.exe"; Required=$true},
        @{Name="WSL"; Command="wsl.exe"; Required=$true},
        @{Name="DiskPart"; Command="diskpart.exe"; Required=$true}
    )
    
    $allAvailable = $true
    
    foreach ($tool in $tools) {
        if (Test-Command $tool.Command) {
            Write-Host "‚úÖ $($tool.Name): Dispon√≠vel" -ForegroundColor Green
        } else {
            Write-Host "‚ùå $($tool.Name): N√£o encontrado" -ForegroundColor Red
            if ($tool.Required) {
                $allAvailable = $false
            }
        }
    }
    
    return $allAvailable
}

# Fun√ß√£o para configurar diret√≥rios
function Setup-Directories {
    Write-Host "üìÅ Configurando diret√≥rios..." -ForegroundColor Yellow
    
    try {
        $directories = @(
            "$env:USERPROFILE\.syntropy",
            "$env:USERPROFILE\.syntropy\cache",
            "$env:USERPROFILE\.syntropy\cache\iso",
            "$env:USERPROFILE\.syntropy\work",
            "$env:USERPROFILE\.syntropy\keys",
            "$env:USERPROFILE\.syntropy\config",
            "$env:USERPROFILE\.syntropy\scripts",
            "$env:USERPROFILE\.syntropy\backups"
        )
        
        foreach ($dir in $directories) {
            if (-not (Test-Path $dir)) {
                New-Item -ItemType Directory -Path $dir -Force | Out-Null
                Write-Host "‚úÖ Criado: $dir" -ForegroundColor Green
            } else {
                Write-Host "‚úÖ Existe: $dir" -ForegroundColor Green
            }
        }
        
        return $true
    } catch {
        Write-Host "‚ùå Erro na cria√ß√£o de diret√≥rios: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

# Fun√ß√£o para testar WSL
function Test-WSLFunctionality {
    Write-Host "üß™ Testando funcionalidade do WSL..." -ForegroundColor Yellow
    
    try {
        # Teste b√°sico
        $testResult = wsl echo "WSL funcionando!" 2>$null
        if ($LASTEXITCODE -eq 0 -and $testResult -eq "WSL funcionando!") {
            Write-Host "‚úÖ WSL b√°sico funcionando" -ForegroundColor Green
        } else {
            Write-Host "‚ùå WSL b√°sico n√£o est√° funcionando" -ForegroundColor Red
            return $false
        }
        
        # Teste de comandos necess√°rios
        $requiredCommands = @("dd", "sgdisk", "mkfs.vfat", "mount", "umount")
        $missingCommands = @()
        
        foreach ($cmd in $requiredCommands) {
            $cmdTest = wsl bash -c "command -v $cmd" 2>$null
            if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Comando $cmd dispon√≠vel" -ForegroundColor Green
            } else {
                Write-Host "‚ùå Comando $cmd n√£o dispon√≠vel" -ForegroundColor Red
                $missingCommands += $cmd
            }
        }
        
        if ($missingCommands.Count -gt 0) {
            Write-Host "‚ö†Ô∏è  Comandos ausentes: $($missingCommands -join ', ')" -ForegroundColor Yellow
            Write-Host "üí° Execute no WSL: sudo apt update && sudo apt install -y gdisk dosfstools" -ForegroundColor Cyan
            return $false
        }
        
        return $true
    } catch {
        Write-Host "‚ùå Erro no teste do WSL: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

# Fun√ß√£o para criar script de verifica√ß√£o
function Create-VerificationScript {
    Write-Host "üìù Criando script de verifica√ß√£o..." -ForegroundColor Yellow
    
    try {
        $scriptContent = @"
# Script de Verifica√ß√£o - USB Syntropy para Windows
# Execute este script para verificar se tudo est√° configurado corretamente

Write-Host "üîç Verifica√ß√£o do Ambiente USB Syntropy" -ForegroundColor Green
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Cyan

# Verificar privil√©gios
`$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
if (`$isAdmin) {
    Write-Host "‚úÖ Executando como Administrador" -ForegroundColor Green
} else {
    Write-Host "‚ùå N√ÉO est√° executando como Administrador" -ForegroundColor Red
}

# Verificar WSL
try {
    `$wslVersion = wsl --version 2>`$null
    if (`$LASTEXITCODE -eq 0) {
        Write-Host "‚úÖ WSL dispon√≠vel" -ForegroundColor Green
    } else {
        Write-Host "‚ùå WSL n√£o dispon√≠vel" -ForegroundColor Red
    }
} catch {
    Write-Host "‚ùå WSL n√£o dispon√≠vel" -ForegroundColor Red
}

# Verificar pol√≠tica de execu√ß√£o
`$policy = Get-ExecutionPolicy -Scope CurrentUser
if (`$policy -eq "Restricted") {
    Write-Host "‚ùå Pol√≠tica de execu√ß√£o restrita: `$policy" -ForegroundColor Red
} else {
    Write-Host "‚úÖ Pol√≠tica de execu√ß√£o adequada: `$policy" -ForegroundColor Green
}

# Verificar ferramentas
`$tools = @("powershell.exe", "wsl.exe", "diskpart.exe")
foreach (`$tool in `$tools) {
    if (Get-Command `$tool -ErrorAction SilentlyContinue) {
        Write-Host "‚úÖ `$tool dispon√≠vel" -ForegroundColor Green
    } else {
        Write-Host "‚ùå `$tool n√£o dispon√≠vel" -ForegroundColor Red
    }
}

# Verificar dispositivos USB
try {
    `$usbDisks = Get-Disk | Where-Object {`$_.BusType -eq 'USB'}
    Write-Host "üíæ Dispositivos USB encontrados: `$(`$usbDisks.Count)" -ForegroundColor Cyan
    foreach (`$disk in `$usbDisks) {
        Write-Host "   ‚Ä¢ PHYSICALDRIVE`$(`$disk.Number) - `$(`$disk.FriendlyName)" -ForegroundColor White
    }
} catch {
    Write-Host "‚ùå Erro ao listar dispositivos USB" -ForegroundColor Red
}

Write-Host ""
Write-Host "üéâ Verifica√ß√£o conclu√≠da!" -ForegroundColor Green
"@
        
        $scriptPath = "$env:USERPROFILE\.syntropy\scripts\verify-environment.ps1"
        $scriptContent | Out-File -FilePath $scriptPath -Encoding UTF8
        Write-Host "‚úÖ Script de verifica√ß√£o criado: $scriptPath" -ForegroundColor Green
        
        return $true
    } catch {
        Write-Host "‚ùå Erro na cria√ß√£o do script: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

# Execu√ß√£o principal
Write-Host "üîß Iniciando configura√ß√£o autom√°tica..." -ForegroundColor Yellow
Write-Host ""

$success = $true

# 1. Verificar ferramentas
if (-not (Install-RequiredTools)) {
    Write-Host "‚ùå Ferramentas necess√°rias n√£o est√£o dispon√≠veis" -ForegroundColor Red
    $success = $false
}

# 2. Configurar pol√≠tica de execu√ß√£o
if (-not $SkipPolicy) {
    if (-not (Set-ExecutionPolicyForSyntropy)) {
        Write-Host "‚ùå Falha na configura√ß√£o da pol√≠tica de execu√ß√£o" -ForegroundColor Red
        $success = $false
    }
}

# 3. Instalar WSL
if (-not $SkipWSL) {
    if (-not (Install-WSL)) {
        Write-Host "‚ùå Falha na instala√ß√£o do WSL" -ForegroundColor Red
        $success = $false
    } else {
        # Configurar distribui√ß√£o
        if (-not (Setup-WSLDistribution -distro $WSLDistro)) {
            Write-Host "‚ùå Falha na configura√ß√£o da distribui√ß√£o WSL" -ForegroundColor Red
            $success = $false
        }
    }
}

# 4. Configurar diret√≥rios
if (-not (Setup-Directories)) {
    Write-Host "‚ùå Falha na configura√ß√£o de diret√≥rios" -ForegroundColor Red
    $success = $false
}

# 5. Testar WSL (se instalado)
if (-not $SkipWSL) {
    if (-not (Test-WSLFunctionality)) {
        Write-Host "‚ö†Ô∏è  WSL instalado mas pode precisar de configura√ß√£o adicional" -ForegroundColor Yellow
        Write-Host "üí° Execute no WSL: sudo apt update && sudo apt install -y gdisk dosfstools" -ForegroundColor Cyan
    }
}

# 6. Criar script de verifica√ß√£o
if (-not (Create-VerificationScript)) {
    Write-Host "‚ö†Ô∏è  Falha na cria√ß√£o do script de verifica√ß√£o" -ForegroundColor Yellow
}

Write-Host ""
Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Cyan

if ($success) {
    Write-Host "üéâ Configura√ß√£o conclu√≠da com sucesso!" -ForegroundColor Green
    Write-Host ""
    Write-Host "üìã Pr√≥ximos passos:" -ForegroundColor Cyan
    Write-Host "1. Execute: syntropy usb-win debug" -ForegroundColor White
    Write-Host "2. Execute: syntropy usb-win list" -ForegroundColor White
    Write-Host "3. Execute: syntropy usb-win create --node-name 'meu-no'" -ForegroundColor White
    Write-Host ""
    Write-Host "üí° Para verificar a configura√ß√£o:" -ForegroundColor Cyan
    Write-Host "   . $env:USERPROFILE\.syntropy\scripts\verify-environment.ps1" -ForegroundColor White
} else {
    Write-Host "‚ùå Configura√ß√£o conclu√≠da com erros" -ForegroundColor Red
    Write-Host ""
    Write-Host "üîß Solu√ß√µes:" -ForegroundColor Cyan
    Write-Host "1. Verifique se voc√™ est√° executando como Administrador" -ForegroundColor White
    Write-Host "2. Verifique sua conex√£o com a internet" -ForegroundColor White
    Write-Host "3. Execute o script novamente com -Force se necess√°rio" -ForegroundColor White
    Write-Host "4. Consulte o guia: GUIA_WINDOWS.md" -ForegroundColor White
}

Write-Host ""
Write-Host "üìö Documenta√ß√£o: GUIA_WINDOWS.md" -ForegroundColor Yellow
